<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><meta name="generator" content="MATLAB R2018a"><meta http-equiv="X-UA-Compatible" content="IE=edge,IE=9,chrome=1"><title>Map Estimation</title><style type="text/css">
* {margin: 0; padding: 0;}
body {text-align: start; line-height: 17.2339992523193px; min-height: 0px; white-space: normal; color: rgb(0, 0, 0); font-family: Menlo, Monaco, Consolas, 'Courier New', monospace; font-style: normal; font-size: 14px; font-weight: normal; text-decoration: none; white-space: normal; }
h1, h2 {font-weight: normal;}
.content { padding: 30px; }

.S0 { margin-left: 0px; margin-top: 0px; margin-bottom: 0px; margin-right: 0px;  }
.S1 { text-align: left; line-height: 26.3999996185303px; min-height: 24px; white-space: pre-wrap; color: rgb(213, 80, 0); font-family: Helvetica, Arial, sans-serif; font-size: 22px; white-space: pre-wrap; margin-left: 4px; margin-top: 3px; margin-bottom: 15px; margin-right: 10px;  }
.S2 { min-height: 0px; margin-left: 0px; margin-top: 0px; margin-bottom: 0px; margin-right: 0px;  }
.S3 { text-align: left; line-height: 20.576000213623px; min-height: 20px; white-space: pre-wrap; color: rgb(60, 60, 60); font-family: Helvetica, Arial, sans-serif; font-size: 16px; font-weight: bold; white-space: pre-wrap; margin-left: 4px; margin-top: 15px; margin-bottom: 9px; margin-right: 10px;  }
.S4 { margin-left: 3px; margin-top: 10px; margin-bottom: 4px; margin-right: 3px;  }
.S5 { min-height: 18px; white-space: nowrap; white-space: nowrap; margin-left: 0px; margin-top: 0px; margin-bottom: 0px; margin-right: 0px;  }
.S6 { min-height: 0px; white-space: pre; white-space: pre; margin-left: 0px; margin-top: 0px; margin-bottom: 0px; margin-right: 0px;  }
.S7 { color: rgb(160, 32, 240); margin-left: 0px; margin-top: 0px; margin-bottom: 0px; margin-right: 0px;  }
.S8 { text-align: left; line-height: 20.576000213623px; min-height: 20px; white-space: pre-wrap; color: rgb(60, 60, 60); font-family: Helvetica, Arial, sans-serif; font-size: 16px; font-weight: bold; white-space: pre-wrap; margin-left: 4px; margin-top: 3px; margin-bottom: 9px; margin-right: 10px;  }
.S9 { text-align: left; line-height: 21px; min-height: 17px; white-space: pre-wrap; font-family: Helvetica, Arial, sans-serif; white-space: pre-wrap; margin-left: 4px; margin-top: 2px; margin-bottom: 9px; margin-right: 10px;  }
.S10 { color: rgb(0, 0, 255); margin-left: 0px; margin-top: 0px; margin-bottom: 0px; margin-right: 0px;  }
.S11 { color: rgb(34, 139, 34); margin-left: 0px; margin-top: 0px; margin-bottom: 0px; margin-right: 0px;  }
.S12 { margin-left: 3px; margin-top: 10px; margin-bottom: 10px; margin-right: 3px;  }
.S13 { text-align: left; line-height: 21px; min-height: 17px; white-space: pre-wrap; font-family: Helvetica, Arial, sans-serif; white-space: pre-wrap; margin-left: 4px; margin-top: 10px; margin-bottom: 9px; margin-right: 10px;  }
.S14 { color: rgb(64, 64, 64); margin-left: 0px; margin-top: 0px; margin-bottom: 0px; margin-right: 0px;  }

.CodeBlock {margin: 10px 0 10px 0; background-color: #F7F7F7;}
.CodeBlock+.paragraphNode {margin-top: 10px;}
.lineNode {padding-left: 10px; border-left: 1px solid #E9E9E9; border-right: 1px solid #E9E9E9;}
.inlineWrapper:first-child .lineNode,.inlineWrapper.outputs+.inlineWrapper .lineNode {padding-top: 5px; border-top: 1px solid #E9E9E9;}
.inlineWrapper:last-child .lineNode,.inlineWrapper.outputs .lineNode {padding-bottom: 5px; border-bottom: 1px solid #E9E9E9;}
.lineNode .textBox {white-space: pre;}
.outputGroup {margin: 2px 0 2px 0; padding: 2px 2px 2px 4px;}
.outputRegion {}
.outputParagraph {color: rgba(64, 64, 64, 1); padding: 10px 0 6px 17px; background: white; overflow-x: hidden;}
.inlineWrapper:last-child .outputParagraph {border-bottom-left-radius: 4px; border-bottom-right-radius: 4px;}
.outputParagraph:empty {margin: 0;}
.inlineElement .symbolicElement {margin-top: 1px; margin-bottom: 1px;}
.embeddedOutputsSymbolicElement .MathEquation {margin-top: 4px; margin-bottom: 4px;}
.embeddedOutputsSymbolicElement .MathEquation.displaySymbolicElement {margin-left: 15px;}
.embeddedOutputsSymbolicElement .MathEquation.inlineSymbolicElement {}
.embeddedOutputsSymbolicElement {overflow-x: auto; overflow-y: auto;}
.embeddedOutputsSymbolicElement { overflow: initial !important;}
.embeddedOutputsSymbolicElement { width: 100% !important; }
.embeddedOutputsTextElement,.embeddedOutputsVariableStringElement {white-space: pre; word-wrap: initial; min-height: 18px; max-height: 250px; overflow: auto;}
.textElement,.rtcDataTipElement .textElement {padding-top: 3px;}
.embeddedOutputsTextElement.inlineElement,.embeddedOutputsVariableStringElement.inlineElement {}
.inlineElement .textElement {}
.embeddedOutputsTextElement,.embeddedOutputsVariableStringElement { max-height: none !important; overflow: initial !important;}
.veSpecifier {}
.veContainer {}
.veSpecifierBox {height: 400px; width: 500px;}
.veSpecifier .veTable {padding-top: 3px; padding-bottom: 4px;}
.veSpecifierBox .veSpecifier .veContainer {position: relative; width: 100%; height: 370px;}
.veSpecifierBox .dijitDialogPaneContent {width: 97% !important; height: 88% !important;}
.veSpecifier .veTable .rowHeadersWrapper {padding-bottom: 0;}
.veSpecifier .veTable .scroller .variableEditorRenderers {padding-right: 3px; -webkit-user-select: none; -moz-user-select: none; -ms-user-select: none;}
.veSpecifier .veTable .topHeaderWrapper,.veSpecifier .veTable .bottomRowHeaderWrapper {visibility: hidden; z-index: 0;}
.veMetaSummary {font-style: italic;}
.veSpecifier .veTable .scroller {overflow: hidden;}
.veSpecifier .veTable:hover .scroller {overflow: auto;}
.veSpecifier .veVariableName,.veSpecifier .veDimensionFont {font-family: Menlo, Monaco, Consolas, "Courier New", monospace; font-size: 12px;}
.veSpecifier .veVariableName {padding-top: 2px;}
.veSpecifier .veDimensionFont {font-style: italic; color: #9A9A9A;}
.veSpecifier .scroller::-webkit-scrollbar-track {background-color: white;}
.veSpecifier .scroller::-webkit-scrollbar-corner {background-color: white;}
.veSpecifier .veTable .topRowHeaderWrapper {border: none; background-color: #F8F9FA;}
.veSpecifier .mw_type_ListBase.showCellBorders,.veSpecifier .veTable .topHeaderWrapper,.veSpecifier .veTable .bottomRowHeaderWrapper,.veSpecifier .veTable .verticalScrollSpacer,.veSpecifier .veTable .horizontalScrollSpacer {border: none;}
.veSpecifier .veTable .dataScrollerNode {border: 1px solid #BFBFBF;}
.veSpecifier .veTable .columnHeaderNode,.veSpecifier .veTable .rowHeaderNode,.veSpecifier .veTable .dataBody {font-family: Arial; font-size: 13px;}
.veSpecifier .veTable .columnHeaderNode,.veSpecifier .veTable .rowHeaderNode {color: #7F7F7F;}
.veSpecifier .veTable .dataBody {color: #000000;}
.veSpecifier .veTable .columnHeaderNode .cell .drag,.veSpecifier .veTable .columnHeaderNode .cell .header,.veSpecifier .veTable .topHeaderWrapper,.veSpecifier .veTable .bottomRowHeaderWrapper {background-color: #F8F9FA;}
.veSpecifier .veTable .columnHeaderNode .cell .dragBorder {border-right: 1px solid #F8F9FA;}
.veSpecifier .veTable .rowHeaderNode .cell {padding-top: 3px; text-align: center; border-bottom: 1px solid #F8F9FA;}
.veSpecifier .veTable .dataBody .cell .plainText {text-align: right;}
.veSpecifier .veTable .dataBody .row .cell {border-bottom: 1px solid #E9E9E9; border-right: 1px solid #E9E9E9;}
.embeddedOutputsVariableElement {white-space: pre-wrap; word-wrap: break-word; min-height: 18px; max-height: 250px; overflow: auto;}
.variableElement {}
.embeddedOutputsVariableElement.inlineElement {}
.inlineElement .variableElement {}
.variableNameElement {margin-bottom: 3px; display: inline-block;}
.variableValue { width: 100% !important; }
.embeddedOutputsMatrixElement,.eoOutputWrapper .matrixElement {min-height: 18px; box-sizing: border-box;}
.embeddedOutputsMatrixElement .matrixElement,.eoOutputWrapper .matrixElement,.rtcDataTipElement .matrixElement {position: relative;}
.matrixElement .variableValue,.rtcDataTipElement .matrixElement .variableValue {white-space: pre; display: inline-block; vertical-align: top; overflow: hidden;}
.embeddedOutputsMatrixElement.inlineElement {}
.embeddedOutputsMatrixElement.inlineElement .topHeaderWrapper {display: none;}
.embeddedOutputsMatrixElement.inlineElement .veTable .body {padding-top: 0 !important; max-height: 100px;}
.inlineElement .matrixElement {max-height: 300px;}
.embeddedOutputsMatrixElement .matrixElement .valueContainer,.eoOutputWrapper .matrixElement .valueContainer,.rtcDataTipElement .matrixElement .valueContainer {white-space: nowrap; margin-bottom: 3px;}
.embeddedOutputsMatrixElement .matrixElement .valueContainer .horizontalEllipsis.hide,.embeddedOutputsMatrixElement .matrixElement .verticalEllipsis.hide,.eoOutputWrapper .matrixElement .valueContainer .horizontalEllipsis.hide,.eoOutputWrapper .matrixElement .verticalEllipsis.hide,.rtcDataTipElement .matrixElement .valueContainer .horizontalEllipsis.hide,.rtcDataTipElement .matrixElement .verticalEllipsis.hide {display: none;}
.embeddedOutputsVariableMatrixElement .matrixElement .valueContainer.hideEllipses .verticalEllipsis, .embeddedOutputsVariableMatrixElement .matrixElement .valueContainer.hideEllipses .horizontalEllipsis {display:none;}
.embeddedOutputsMatrixElement .matrixElement .valueContainer .horizontalEllipsis,.eoOutputWrapper .matrixElement .valueContainer .horizontalEllipsis {margin-bottom: -3px;}
.eoOutputWrapper .embeddedOutputsVariableMatrixElement .matrixElement .valueContainer {cursor: default !important;}
.matrixElement { max-height: none !important; }
.embeddedOutputsVariableTableElement .ClientViewDiv table tr {height: 22px; white-space: nowrap;}
.embeddedOutputsVariableTableElement .ClientViewDiv table tr td,.embeddedOutputsVariableTableElement .ClientViewDiv table tr th {min-width : 75px; max-width : 75px; background-color:white; text-overflow: ellipsis; font-family: 'Arial', sans-serif; font-size: 12px; overflow : hidden;}
.embeddedOutputsVariableTableElement .ClientViewDiv table tbody tr th {width: 34px; max-width: 100px;}
.embeddedOutputsVariableTableElement .ClientViewDiv table tr span {text-overflow: ellipsis; padding: 3px;}
.embeddedOutputsVariableTableElement .ClientViewDiv table tr th {color: rgba(0,0,0,0.5); padding: 3px; font-size: 9px;}
.embeddedOutputsVariableTableElement .ClientViewDiv table tr th:first-child {min-width: 28px; max-width: 250px;}
.dijitTooltipDialog .dijitTooltipContainer .dijitTooltipContents .alertPlugin-alertMessage {min-width: 12px; max-width: 400px; max-height: 300px; overflow: auto;}
.dijitTooltipDialog .alertPlugin-alertMessage::-webkit-scrollbar {width: 11px; height: 11px;}
.dijitTooltipDialog .alertPlugin-alertMessage::-webkit-scrollbar-track {background-color: rgba(0, 0, 0, 0);}
.dijitTooltipDialog .alertPlugin-alertMessage::-webkit-scrollbar-corner {background-color: rgba(0, 0, 0, 0);}
.dijitTooltipDialog .alertPlugin-alertMessage::-webkit-scrollbar-thumb {border-radius: 7px; background-color: rgba(0, 0, 0, 0.1); border: 2px solid rgba(0, 0, 0, 0); background-clip: padding-box;}
.dijitTooltipDialog .alertPlugin-alertMessage::-webkit-scrollbar-thumb:hover {background-color: rgba(0, 0, 0, 0.2);}
.dijitTooltipDialog .alertPlugin-alertMessage::-webkit-scrollbar-thumb {background-color: rgba(0, 0, 0, 0);}
.dijitTooltipDialog .alertPlugin-alertMessage:hover::-webkit-scrollbar-thumb {background-color: rgba(0, 0, 0, 0.1);}
.dijitTooltipDialog .alertPlugin-alertMessage:hover::-webkit-scrollbar-thumb:hover {background-color: rgba(0, 0, 0, 0.2);}
.alertPlugin-alertLine {position: absolute; display: initial; width: 40px; text-align: right; cursor: text;}
.alertPlugin-onTextLine {visibility: hidden;}
.alertPlugin-hasTooltip .alertPlugin-warningImg,.alertPlugin-hasTooltip .alertPlugin-errorImg {cursor: pointer;}
.alertPlugin-alertLine .alertPlugin-warningElement,.alertPlugin-alertLine .alertPlugin-errorElement {display: inline-block; margin-right: 4px;}
.alertPlugin-isStale {-webkit-filter: opacity(0.4) grayscale(80%); filter: opacity(0.4) grayscale(80%);}
.diagnosticMessage-wrapper {font-family: Menlo, Monaco, Consolas, "Courier New", monospace; font-size: 12px;}
.diagnosticMessage-wrapper.diagnosticMessage-warningType {color: rgb(255,100,0);}
.diagnosticMessage-wrapper.diagnosticMessage-warningType a {color: rgb(255,100,0); text-decoration: underline;}
.diagnosticMessage-wrapper.diagnosticMessage-errorType {color: rgb(230,0,0);}
.diagnosticMessage-wrapper.diagnosticMessage-errorType a {color: rgb(230,0,0); text-decoration: underline;}
.diagnosticMessage-wrapper .diagnosticMessage-messagePart {white-space: pre-wrap;}
.diagnosticMessage-wrapper .diagnosticMessage-stackPart {white-space: pre;}
.embeddedOutputsWarningElement{min-height: 18px; max-height: 250px; overflow: auto;}
.embeddedOutputsWarningElement.inlineElement {}
.embeddedOutputsErrorElement {min-height: 18px; max-height: 250px; overflow: auto;}
.embeddedOutputsErrorElement.inlineElement {}
.variableNameElement .headerElement {color: rgb(179, 179, 179); font-style: italic;}
.variableNameElement .headerElement .headerDataType {color: rgb(147, 176, 230);}
.matrixElement .horizontalEllipsis,.rtcDataTipElement .matrixElement .horizontalEllipsis {display: inline-block; margin-top: 3px; width: 30px; height: 12px; background-repeat: no-repeat; background-image: url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAB0AAAAJCAYAAADO1CeCAAAAJUlEQVR42mP4//8/A70xw0i29BUDFPxnAEtTW37wWDqakIa4pQDvOOG89lHX2gAAAABJRU5ErkJggg==");}
.matrixElement .verticalEllipsis,.textElement .verticalEllipsis,.rtcDataTipElement .matrixElement .verticalEllipsis,.rtcDataTipElement .textElement .verticalEllipsis {margin-left: 35px; width: 12px; height: 30px; background-repeat: no-repeat; background-image: url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAoAAAAZCAYAAAAIcL+IAAAALklEQVR42mP4//8/AzGYgWyFMECMwv8QddRS+P//KyimlmcGUOFoOI6GI/UVAgDnd8Dd4+NCwgAAAABJRU5ErkJggg==");}
</style></head><body><div class = "content"><div class = 'SectionBlock containment active'><h1 class = "S1"><span class = "S2"><span class="S0">Map Estimation</span></span></h1><h2 class = "S3"><span class = "S2"><span class="S0">1. Load data</span></span></h2><div class = 'CodeBlock contiguous'><div class = 'inlineWrapper'><div class = "S5 lineNode"><span class = "S6"><span class="S0">clear </span><span class="S7">all</span><span class="S0">; warning </span><span class="S7">off</span></span></div></div><div class = 'inlineWrapper'><div class = "S5 lineNode"><span class = "S6"><span class="S0">load(</span><span class="S7">'./data/Density_inference.mat'</span><span class="S0">,</span><span class="S7">'data'</span><span class="S0">);</span></span></div></div><div class = 'inlineWrapper'><div class = "S5 lineNode"><span class = "S6"><span class="S0">load(</span><span class="S7">'./data/Density_estimationMap'</span><span class="S0">,</span><span class="S7">'g'</span><span class="S0">);</span></span></div></div><div class = 'inlineWrapper'><div class = "S5 lineNode"><span class = "S6"><span class="S0">load(</span><span class="S7">'./data/Flight_inference.mat'</span><span class="S0">);</span></span></div></div><div class = 'inlineWrapper'><div class = "S5 lineNode"><span class = "S6"><span class="S0">addpath(</span><span class="S7">'./functions/'</span><span class="S0">); </span></span></div></div><div class = 'inlineWrapper'><div class = "S5 lineNode"><span class = "S6"><span class="S0">load </span><span class="S7">coastlines.mat</span></span></div></div></div></div><div class = "S0"></div><div class = 'SectionBlock containment'><h2 class = "S8"><span class = "S2"><span class="S0">4. Multi-night scale</span></span></h2><div class = "S9"><span class = "S2"><span class="S0">Covariance matrix of weather radars</span></span></div><div class = 'CodeBlock contiguous'><div class = 'inlineWrapper'><div class = "S5 lineNode"><span class = "S6"><span class="S0">gfmulti.Mu_est = nan(g.nlm,g.nat);</span></span></div></div><div class = 'inlineWrapper'><div class = "S5 lineNode"><span class = "S6"><span class="S0">gfmulti.Mu_sig = nan(g.nlm,g.nat);</span></span></div></div><div class = 'inlineWrapper'><div class = "S5 lineNode"><span class = "S6"><span class="S0">gfmulti.Mv_est = nan(g.nlm,g.nat);</span></span></div></div><div class = 'inlineWrapper'><div class = "S5 lineNode"><span class = "S6"><span class="S0">gfmulti.Mv_est = nan(g.nlm,g.nat);</span></span></div></div><div class = 'inlineWrapper'><div class = "S5 lineNode"><span class = "S6"><span class="S0"></span></span></div></div><div class = 'inlineWrapper'><div class = "S5 lineNode"><span class = "S6"><span class="S10">for </span><span class="S0">i_b=1:numel(data.block.date)</span></span></div></div><div class = 'inlineWrapper'><div class = "S5 lineNode"><span class = "S6"><span class="S0">    id = ~fmulti.isnan &amp; fmulti.B==i_b;</span></span></div></div><div class = 'inlineWrapper'><div class = "S5 lineNode"><span class = "S6"><span class="S0">    Dtime=squareform(pdist(fmulti.T(id)));</span></span></div></div><div class = 'inlineWrapper'><div class = "S5 lineNode"><span class = "S6"><span class="S0">    Ddist_aa=squareform(pdist([data.lat(fmulti.R(id)) data.lon(fmulti.R(id))],@lldistkm));</span></span></div></div><div class = 'inlineWrapper'><div class = "S5 lineNode"><span class = "S6"><span class="S0">    </span></span></div></div><div class = 'inlineWrapper'><div class = "S5 lineNode"><span class = "S6"><span class="S0">    Ddist_ab = pdist2([data.lat data.lon], [g.lat2D(g.latlonmask) g.lon2D(g.latlonmask)], @lldistkm);</span></span></div></div><div class = 'inlineWrapper'><div class = "S5 lineNode"><span class = "S6"><span class="S0">    Ddist_sf = Ddist_ab(fmulti.R(id), repmat((1:g.nlm)',sum(g.day_b==i_b),1));</span></span></div></div><div class = 'inlineWrapper'><div class = "S5 lineNode"><span class = "S6"><span class="S0">    Dtime_sf = pdist2(fmulti.T(id), repelem(datenum(g.day(g.day_b==i_b)),g.nlm,1));</span></span></div></div><div class = 'inlineWrapper'><div class = "S5 lineNode"><span class = "S6"><span class="S0">    </span></span></div></div><div class = 'inlineWrapper'><div class = "S5 lineNode"><span class = "S6"><span class="S0">    </span><span class="S11">% u</span></span></div></div><div class = 'inlineWrapper'><div class = "S5 lineNode"><span class = "S6"><span class="S0">    Caa = fmulti.cov.C_u(Ddist_aa,Dtime,i_b);</span></span></div></div><div class = 'inlineWrapper'><div class = "S5 lineNode"><span class = "S6"><span class="S0">    Cab = fmulti.cov.C_u(Ddist_sf,Dtime_sf,i_b);</span></span></div></div><div class = 'inlineWrapper'><div class = "S5 lineNode"><span class = "S6"><span class="S0">    Lambda = </span><span class="S0">inv</span><span class="S0">(Caa)*Cab;</span></span></div></div><div class = 'inlineWrapper'><div class = "S5 lineNode"><span class = "S6"><span class="S0">    gfmulti.Mu_est(:,g.day_b==i_b) = reshape((Lambda' * fmulti.Mus(id)) + fmulti.f_trend(repelem(datenum(g.day(g.day_b==i_b)),g.nlm,1), repmat(g.lat2D(g.latlonmask),sum(g.day_b==i_b),1), repmat(g.lon2D(g.latlonmask),sum(g.day_b==i_b),1), fmulti.beta_u(:,i_b)), g.nlm, sum(g.day_b==i_b));</span></span></div></div><div class = 'inlineWrapper'><div class = "S5 lineNode"><span class = "S6"><span class="S0">    gfmulti.Mu_sig(:,g.day_b==i_b) = reshape( sqrt(sum(fmulti.cov.parm_u(1:2,i_b)) - sum(Lambda.*Cab)), g.nlm, sum(g.day_b==i_b));</span></span></div></div><div class = 'inlineWrapper'><div class = "S5 lineNode"><span class = "S6"><span class="S0">    </span></span></div></div><div class = 'inlineWrapper'><div class = "S5 lineNode"><span class = "S6"><span class="S0">    </span><span class="S11">% v</span></span></div></div><div class = 'inlineWrapper'><div class = "S5 lineNode"><span class = "S6"><span class="S0">    Caa = fmulti.cov.C_v(Ddist_aa,Dtime,i_b);</span></span></div></div><div class = 'inlineWrapper'><div class = "S5 lineNode"><span class = "S6"><span class="S0">    Cab = fmulti.cov.C_v(Ddist_sf,Dtime_sf,i_b);</span></span></div></div><div class = 'inlineWrapper'><div class = "S5 lineNode"><span class = "S6"><span class="S0">    Lambda = </span><span class="S0">inv</span><span class="S0">(Caa)*Cab;</span></span></div></div><div class = 'inlineWrapper'><div class = "S5 lineNode"><span class = "S6"><span class="S0">    gfmulti.Mv_est(:,g.day_b==i_b) = reshape((Lambda' * fmulti.Mvs(id)) + fmulti.f_trend(repelem(datenum(g.day(g.day_b==i_b)),g.nlm,1), repmat(g.lat2D(g.latlonmask),sum(g.day_b==i_b),1), repmat(g.lon2D(g.latlonmask),sum(g.day_b==i_b),1), fmulti.beta_v(:,i_b)), g.nlm, sum(g.day_b==i_b));</span></span></div></div><div class = 'inlineWrapper'><div class = "S5 lineNode"><span class = "S6"><span class="S0">    gfmulti.Mv_sig(:,g.day_b==i_b) = reshape( sqrt(sum(fmulti.cov.parm_v(1:2,i_b)) - sum(Lambda.*Cab)), g.nlm, sum(g.day_b==i_b));</span></span></div></div><div class = 'inlineWrapper'><div class = "S5 lineNode"><span class = "S6"><span class="S0">        </span></span></div></div><div class = 'inlineWrapper'><div class = "S5 lineNode"><span class = "S6"><span class="S10">end</span></span></div></div></div></div><div class = "S0"></div><div class = 'SectionBlock containment'><div class = "S9"><span class = "S2"><span class="S0">Figure</span></span></div><div class = 'CodeBlock contiguous'><div class = 'inlineWrapper'><div class = "S5 lineNode"><span class = "S6"><span class="S11">% tmp=nan(g.nlat, g.nlon);</span></span></div></div><div class = 'inlineWrapper'><div class = "S5 lineNode"><span class = "S6"><span class="S11">% figure('position',[0 0 1000 600]); </span></span></div></div><div class = 'inlineWrapper'><div class = "S5 lineNode"><span class = "S6"><span class="S11">% i=1;</span></span></div></div><div class = 'inlineWrapper'><div class = "S5 lineNode"><span class = "S6"><span class="S11">% for i_t = 1:12:4*6</span></span></div></div><div class = 'inlineWrapper'><div class = "S5 lineNode"><span class = "S6"><span class="S11">%     subplot(4,6,i); hold on; i=i+1;</span></span></div></div><div class = 'inlineWrapper'><div class = "S5 lineNode"><span class = "S6"><span class="S11">%     h=worldmap([min([g.lat]) max([g.lat])], [min([g.lon]) max([g.lon])]); </span></span></div></div><div class = 'inlineWrapper'><div class = "S5 lineNode"><span class = "S6"><span class="S11">%     setm(h,'frame','on','grid','off'); set(findall(h,'Tag','MLabel'),'visible','off'); set(findall(h,'Tag','PLabel'),'visible','off')</span></span></div></div><div class = 'inlineWrapper'><div class = "S5 lineNode"><span class = "S6"><span class="S11">%     geoshow('landareas.shp', 'FaceColor', [215 215 215]./255); geoshow('worldrivers.shp','Color', 'blue')</span></span></div></div><div class = 'inlineWrapper'><div class = "S5 lineNode"><span class = "S6"><span class="S11">%     tmp(g.latlonmask) = gfmulti.Mu_est(:,i_t);</span></span></div></div><div class = 'inlineWrapper'><div class = "S5 lineNode"><span class = "S6"><span class="S11">%     surfm(g.lat2D,g.lon2D,tmp); caxis([-15 15])</span></span></div></div><div class = 'inlineWrapper'><div class = "S5 lineNode"><span class = "S6"><span class="S11">%     i_tt=find(datenum(g.day(i_t))==data.day);</span></span></div></div><div class = 'inlineWrapper'><div class = "S5 lineNode"><span class = "S6"><span class="S11">%     scatterm(data.lat(~isnan(fmulti.Mus(i_tt,:))),data.lon(~isnan(fmulti.Mus(i_tt,:))),100,fmulti.Mus(i_tt,~isnan(fmulti.Mus(i_tt,:))),'filled','MarkerEdgeColor','k')</span></span></div></div><div class = 'inlineWrapper'><div class = "S5 lineNode"><span class = "S6"><span class="S11">%     title(datestr(g.day(i_t),'dd-mmm'))</span></span></div></div><div class = 'inlineWrapper'><div class = "S5 lineNode"><span class = "S6"><span class="S11">% end</span></span></div></div></div></div><div class = "S0"></div><div class = 'SectionBlock containment'><div class = "S9"><span class = "S2"><span class="S0">Export as gif</span></span></div><div class = 'CodeBlock contiguous'><div class = 'inlineWrapper'><div class = "S5 lineNode"><span class = "S6"><span class="S11">% % filename='data/Density_estimationMap_M';</span></span></div></div><div class = 'inlineWrapper'><div class = "S5 lineNode"><span class = "S6"><span class="S11">% filename='data/Density_estimationMap_M';</span></span></div></div><div class = 'inlineWrapper'><div class = "S5 lineNode"><span class = "S6"><span class="S11">% Frame(g.nat) = struct('cdata',[],'colormap',[]); </span></span></div></div><div class = 'inlineWrapper'><div class = "S5 lineNode"><span class = "S6"><span class="S11">% fig=figure(2); </span></span></div></div><div class = 'inlineWrapper'><div class = "S5 lineNode"><span class = "S6"><span class="S11">% h=worldmap([min([g.lat]) max([g.lat])], [min([g.lon]) max([g.lon])]); </span></span></div></div><div class = 'inlineWrapper'><div class = "S5 lineNode"><span class = "S6"><span class="S11">% setm(h,'frame','on','grid','off'); set(findall(h,'Tag','MLabel'),'visible','off'); set(findall(h,'Tag','PLabel'),'visible','off')</span></span></div></div><div class = 'inlineWrapper'><div class = "S5 lineNode"><span class = "S6"><span class="S11">% geoshow('landareas.shp', 'FaceColor', [215 215 215]./255); geoshow('worldrivers.shp','Color', 'blue')</span></span></div></div><div class = 'inlineWrapper'><div class = "S5 lineNode"><span class = "S6"><span class="S11">% set(gcf,'color','w'); hsurf=[];hscat=[];</span></span></div></div><div class = 'inlineWrapper'><div class = "S5 lineNode"><span class = "S6"><span class="S11">% caxis([-3 3]); </span></span></div></div><div class = 'inlineWrapper'><div class = "S5 lineNode"><span class = "S6"><span class="S11">% tmp=nan(g.nlat, g.nlon);</span></span></div></div><div class = 'inlineWrapper'><div class = "S5 lineNode"><span class = "S6"><span class="S11">% %caxis([0 80]);  c=colorbar;c.Label.String = 'Bird density [bird/km^2]';c.Label.FontSize=14;</span></span></div></div><div class = 'inlineWrapper'><div class = "S5 lineNode"><span class = "S6"><span class="S11">% for i_t = 1:g.nat</span></span></div></div><div class = 'inlineWrapper'><div class = "S5 lineNode"><span class = "S6"><span class="S11">%     delete(hsurf); delete(hscat)</span></span></div></div><div class = 'inlineWrapper'><div class = "S5 lineNode"><span class = "S6"><span class="S11">%     tmp(g.latlonmask) = gmulti.M_est(:,i_t);</span></span></div></div><div class = 'inlineWrapper'><div class = "S5 lineNode"><span class = "S6"><span class="S11">%     hsurf=surfm(g.lat2D,g.lon2D,tmp);</span></span></div></div><div class = 'inlineWrapper'><div class = "S5 lineNode"><span class = "S6"><span class="S11">%     i_tt=find(datenum(g.day(i_t))==data.day);</span></span></div></div><div class = 'inlineWrapper'><div class = "S5 lineNode"><span class = "S6"><span class="S11">%     hscat=scatterm(data.lat(~isnan(multi.M_m(i_tt,:))),data.lon(~isnan(multi.M_m(i_tt,:))),100,multi.M_m(i_tt,~isnan(multi.M_m(i_tt,:))),'filled','MarkerEdgeColor','k');</span></span></div></div><div class = 'inlineWrapper'><div class = "S5 lineNode"><span class = "S6"><span class="S11">%     </span></span></div></div><div class = 'inlineWrapper'><div class = "S5 lineNode"><span class = "S6"><span class="S11">%     title(datestr(g.day(i_t),'dd-mmm'),'FontSize',14); drawnow;</span></span></div></div><div class = 'inlineWrapper'><div class = "S5 lineNode"><span class = "S6"><span class="S11">%     Frame(i_t) = getframe(fig);</span></span></div></div><div class = 'inlineWrapper'><div class = "S5 lineNode"><span class = "S6"><span class="S11">%     [imind,cm] = rgb2ind(frame2im(Frame(i_t)),256); </span></span></div></div><div class = 'inlineWrapper'><div class = "S5 lineNode"><span class = "S6"><span class="S11">%     if i_t == 1</span></span></div></div><div class = 'inlineWrapper'><div class = "S5 lineNode"><span class = "S6"><span class="S11">%         imwrite(imind,cm,[filename '.gif'],'gif','Loopcount',inf);</span></span></div></div><div class = 'inlineWrapper'><div class = "S5 lineNode"><span class = "S6"><span class="S11">%     else</span></span></div></div><div class = 'inlineWrapper'><div class = "S5 lineNode"><span class = "S6"><span class="S11">%         imwrite(imind,cm,[filename '.gif'],'gif','WriteMode','append');</span></span></div></div><div class = 'inlineWrapper'><div class = "S5 lineNode"><span class = "S6"><span class="S11">%     end</span></span></div></div><div class = 'inlineWrapper'><div class = "S5 lineNode"><span class = "S6"><span class="S11">% end</span></span></div></div><div class = 'inlineWrapper'><div class = "S5 lineNode"><span class = "S6"><span class="S0"></span></span></div></div></div><div class = "S13"><span class = "S2"><span class="S0"></span></span></div></div><div class = "S0"></div><div class = 'SectionBlock containment'><h2 class = "S8"><span class = "S2"><span class="S0">5. Intra-night scale</span></span></h2><div class = "S9"><span class = "S2"><span class="S0">Covariance matrix of weather radar data </span></span></div><div class = 'CodeBlock contiguous'><div class = 'inlineWrapper'><div class = "S5 lineNode"><span class = "S6"><span class="S0">gfintra.Ius_est = nan(g.nlm,g.nt);</span></span></div></div><div class = 'inlineWrapper'><div class = "S5 lineNode"><span class = "S6"><span class="S0">gfintra.Ius_sig = nan(g.nlm,g.nt);</span></span></div></div><div class = 'inlineWrapper'><div class = "S5 lineNode"><span class = "S6"><span class="S0">gfintra.Ivs_est = nan(g.nlm,g.nt);</span></span></div></div><div class = 'inlineWrapper'><div class = "S5 lineNode"><span class = "S6"><span class="S0">gfintra.Ivs_sig = nan(g.nlm,g.nt);</span></span></div></div><div class = 'inlineWrapper'><div class = "S5 lineNode"><span class = "S6"><span class="S0"></span></span></div></div><div class = 'inlineWrapper'><div class = "S5 lineNode"><span class = "S6"><span class="S0">Ddist_rr_sm = squareform(pdist([data.lat data.lon], @lldistkm));</span></span></div></div><div class = 'inlineWrapper'><div class = "S5 lineNode"><span class = "S6"><span class="S0">Ddist_rg_sm = pdist2([data.lat data.lon], [g.lat2D(g.latlonmask) g.lon2D(g.latlonmask)], @lldistkm);</span></span></div></div><div class = 'inlineWrapper'><div class = "S5 lineNode"><span class = "S6"><span class="S0">tic</span></span></div></div><div class = 'inlineWrapper'><div class = "S5 lineNode"><span class = "S6"><span class="S10">for </span><span class="S0">i_t=1:g.nt</span></span></div></div><div class = 'inlineWrapper'><div class = "S5 lineNode"><span class = "S6"><span class="S0">    disp([num2str(round(i_t/g.nat*100)) </span><span class="S7">'%  ' </span><span class="S0">num2str(toc/60) </span><span class="S7">'min'</span><span class="S0">])</span></span></div></div><div class = 'inlineWrapper'><div class = "S5 lineNode"><span class = "S6"><span class="S0">    i_b = g.day_b(i_t);</span></span></div></div><div class = 'inlineWrapper'><div class = "S5 lineNode"><span class = "S6"><span class="S0">    id_r = fintra.day==datenum(g.day(i_t));</span></span></div></div><div class = 'inlineWrapper'><div class = "S5 lineNode"><span class = "S6"><span class="S0">    id_g = g.day_id == i_t;</span></span></div></div><div class = 'inlineWrapper'><div class = "S5 lineNode"><span class = "S6"><span class="S0">    </span></span></div></div><div class = 'inlineWrapper'><div class = "S5 lineNode"><span class = "S6"><span class="S0">    Dtime_rr = squareform(pdist(fintra.time(id_r)));</span></span></div></div><div class = 'inlineWrapper'><div class = "S5 lineNode"><span class = "S6"><span class="S0">    Ddist_rr = Ddist_rr_sm(fintra.radar(id_r),fintra.radar(id_r));</span></span></div></div><div class = 'inlineWrapper'><div class = "S5 lineNode"><span class = "S6"><span class="S0">    </span></span></div></div><div class = 'inlineWrapper'><div class = "S5 lineNode"><span class = "S6"><span class="S0">    Dtime_rg = pdist2(fintra.time(id_r),datenum(g.time(id_g)));</span></span></div></div><div class = 'inlineWrapper'><div class = "S5 lineNode"><span class = "S6"><span class="S0">    Dtime_rg = Dtime_rg(:,repelem((1:sum(id_g))',g.nlm,1));</span></span></div></div><div class = 'inlineWrapper'><div class = "S5 lineNode"><span class = "S6"><span class="S0">    Ddist_rg = Ddist_rg_sm(fintra.radar(id_r),:);</span></span></div></div><div class = 'inlineWrapper'><div class = "S5 lineNode"><span class = "S6"><span class="S0">    Ddist_rg = repmat(Ddist_rg,1,sum(id_g));</span></span></div></div><div class = 'inlineWrapper'><div class = "S5 lineNode"><span class = "S6"><span class="S0">    </span></span></div></div><div class = 'inlineWrapper'><div class = "S5 lineNode"><span class = "S6"><span class="S0">    id = g.mask_day(:,id_g);</span></span></div></div><div class = 'inlineWrapper'><div class = "S5 lineNode"><span class = "S6"><span class="S0">    id2 = false(size(gfintra.Ius_est));</span></span></div></div><div class = 'inlineWrapper'><div class = "S5 lineNode"><span class = "S6"><span class="S0">    id2(:,id_g)=id;</span></span></div></div><div class = 'inlineWrapper'><div class = "S5 lineNode"><span class = "S6"><span class="S0">    </span></span></div></div><div class = 'inlineWrapper'><div class = "S5 lineNode"><span class = "S6"><span class="S0">    </span><span class="S11">% u</span></span></div></div><div class = 'inlineWrapper'><div class = "S5 lineNode"><span class = "S6"><span class="S0">    Crr = fintra.cov.C_u(Ddist_rr,Dtime_rr,i_b);</span></span></div></div><div class = 'inlineWrapper'><div class = "S5 lineNode"><span class = "S6"><span class="S0">    Crg = fintra.cov.C_u(Ddist_rg(:,id(:)),Dtime_rg(:,id(:)),i_b);</span></span></div></div><div class = 'inlineWrapper'><div class = "S5 lineNode"><span class = "S6"><span class="S0">    Lambda = </span><span class="S0">inv</span><span class="S0">(Crr)*Crg;</span></span></div></div><div class = 'inlineWrapper'><div class = "S5 lineNode"><span class = "S6"><span class="S0"></span></span></div></div><div class = 'inlineWrapper'><div class = "S5 lineNode"><span class = "S6"><span class="S0">    gfintra.Ius_est(id2) = (Lambda' * fintra.Ius_n(id_r)) .* sqrt(fintra.f_trend(g.NNT(id2),fintra.beta_u(:,i_b)));</span></span></div></div><div class = 'inlineWrapper'><div class = "S5 lineNode"><span class = "S6"><span class="S0">    gfintra.Ius_sig(id2) = sqrt( (sum(fintra.cov.parm_u(1:2,i_b)) - sum(Lambda.*Crg))  .* fintra.f_trend(g.NNT(id2)',fintra.beta_u(:,i_b)) ); </span></span></div></div><div class = 'inlineWrapper'><div class = "S5 lineNode"><span class = "S6"><span class="S0">    </span></span></div></div><div class = 'inlineWrapper'><div class = "S5 lineNode"><span class = "S6"><span class="S0">    </span><span class="S11">% v</span></span></div></div><div class = 'inlineWrapper'><div class = "S5 lineNode"><span class = "S6"><span class="S0">    Crr = fintra.cov.C_v(Ddist_rr,Dtime_rr,i_b);</span></span></div></div><div class = 'inlineWrapper'><div class = "S5 lineNode"><span class = "S6"><span class="S0">    Crg = fintra.cov.C_v(Ddist_rg(:,id(:)),Dtime_rg(:,id(:)),i_b);</span></span></div></div><div class = 'inlineWrapper'><div class = "S5 lineNode"><span class = "S6"><span class="S0">    Lambda = </span><span class="S0">inv</span><span class="S0">(Crr)*Crg;</span></span></div></div><div class = 'inlineWrapper'><div class = "S5 lineNode"><span class = "S6"><span class="S0"></span></span></div></div><div class = 'inlineWrapper'><div class = "S5 lineNode"><span class = "S6"><span class="S0">    gfintra.Ivs_est(id2) = (Lambda' * fintra.Ivs_n(id_r)) .* sqrt(fintra.f_trend(g.NNT(id2),fintra.beta_v(:,i_b)));</span></span></div></div><div class = 'inlineWrapper'><div class = "S5 lineNode"><span class = "S6"><span class="S0">    gfintra.Ivs_sig(id2) = sqrt( (sum(fintra.cov.parm_v(1:2,i_b)) - sum(Lambda.*Crg))  .* fintra.f_trend(g.NNT(id2)',fintra.beta_v(:,i_b)) ); </span></span></div></div><div class = 'inlineWrapper'><div class = "S5 lineNode"><span class = "S6"><span class="S0">        </span></span></div></div><div class = 'inlineWrapper outputs'><div class = "S5 lineNode"><span class = "S6"><span class="S10">end</span></span></div><div class="outputParagraph" style="white-space: normal; font-style: normal; color: rgb(64, 64, 64); font-size: 14px;"><div class="inlineElement eoOutputWrapper embeddedOutputsTextElement scrollableOutput" uid="8A6B2005" data-testid="output_0" data-width="1098" data-height="1697" style="width: 1128px; max-height: 261px; white-space: pre; font-style: normal; color: rgb(64, 64, 64); font-size: 12px;"><div class="textElement" style="white-space: pre; font-style: normal; color: rgb(64, 64, 64); font-size: 12px;">63%  0.00020022min<br>63%  1.3447min<br>63%  2.6335min<br>64%  4.1346min<br>64%  5.3797min<br>64%  6.4421min<br>65%  7.9752min<br>65%  9.595min<br>65%  11.3633min<br>66%  12.9379min<br>66%  14.4416min<br>66%  15.9009min<br>66%  17.346min<br>67%  18.2293min<br>67%  19.1239min<br>67%  20.0114min<br>68%  20.8113min<br>68%  21.6486min<br>68%  22.5732min<br>69%  24.5013min<br>69%  25.6634min<br>69%  26.2404min<br>70%  27.3124min<br>70%  29.3997min<br>70%  31.2628min<br>70%  33.1866min<br>71%  35.2206min<br>71%  37.37min<br>71%  39.4581min<br>72%  41.2183min<br>72%  42.4299min<br>72%  43.8838min<br>73%  46.1516min<br>73%  48.2846min<br>73%  50.9065min<br>74%  52.0577min<br>74%  54.4468min<br>74%  57.0572min<br>75%  59.7477min<br>75%  61.8377min<br>75%  63.4283min<br>75%  65.3883min<br>76%  67.0533min<br>76%  68.431min<br>76%  70.5588min<br>77%  73.3181min<br>77%  75.873min<br>77%  78.5863min<br>78%  81.7525min<br>78%  84.5773min<br>78%  87.3403min<br>79%  89.9222min<br>79%  91.4315min<br>79%  93.1336min<br>80%  95.9779min<br>80%  96.9507min<br>80%  99.0176min<br>80%  100.4399min<br>81%  101.5479min<br>81%  103.3783min<br>81%  105.2804min<br>82%  107.1296min<br>82%  110.2455min<br>82%  113.6453min<br>83%  117.1945min<br>83%  119.5047min<br>83%  121.8069min<br>84%  123.8302min<br>84%  125.5872min<br>84%  127.1989min<br>84%  127.8508min<br>85%  129.3748min<br>85%  130.9591min<br>85%  134.5831min<br>86%  138.1884min<br>86%  142.579min<br>86%  145.9066min<br>87%  148.4292min<br>87%  150.4882min<br>87%  152.0014min<br>88%  153.4158min<br>88%  156.0358min<br>88%  158.3165min<br>89%  159.5576min<br>89%  161.0168min<br>89%  162.4561min<br>89%  164.0192min<br>90%  165.0165min<br>90%  166.0615min<br>90%  167.2492min<br>91%  169.1244min<br>91%  169.4264min<br>91%  169.6019min<br>92%  170.4447min<br>92%  172.843min<br>92%  173.405min<br>93%  174.3812min<br>93%  174.9055min<br>93%  175.0369min<br>93%  176.0008min<br>94%  177.9381min<br>94%  180.224min<br>94%  182.7225min<br>95%  184.9022min<br>95%  186.9295min<br>95%  187.7318min<br>96%  188.7592min<br>96%  190.9804min<br>96%  191.8958min<br>97%  192.5919min<br>97%  193.0609min<br>97%  193.7238min<br>98%  194.887min<br>98%  195.9352min<br>98%  197.4169min<br>98%  199.8948min<br>99%  202.1372min<br>99%  204.1253min<br>99%  205.9287min<br>100%  207.321min<br>100%  208.4891min</div></div></div></div></div></div><div class = "S0"></div><div class = 'SectionBlock containment'><h2 class = "S8"><span class = "S2"><span class="S0">6 Reassemble</span></span></h2><div class = 'CodeBlock contiguous'><div class = 'inlineWrapper'><div class = "S5 lineNode"><span class = "S6"><span class="S0">guv.u_est = gfmulti.Mu_est(:,g.day_id) + gfintra.Ius_est;</span></span></div></div><div class = 'inlineWrapper'><div class = "S5 lineNode"><span class = "S6"><span class="S0">guv.v_est = gfmulti.Mv_est(:,g.day_id) + gfintra.Ivs_est;</span></span></div></div><div class = 'inlineWrapper'><div class = "S5 lineNode"><span class = "S6"><span class="S0">guv.u_sig = sqrt(gfmulti.Mu_sig(:,g.day_id).^2 + gfintra.Ius_sig.^2);</span></span></div></div><div class = 'inlineWrapper'><div class = "S5 lineNode"><span class = "S6"><span class="S0">guv.v_sig = sqrt(gfmulti.Mv_sig(:,g.day_id).^2 + gfintra.Ivs_sig.^2);</span></span></div></div></div></div><div class = "S0"></div><div class = 'SectionBlock containment'><div class = "S9"><span class = "S2"><span class="S0">Figure</span></span></div><div class = 'CodeBlock contiguous'><div class = 'inlineWrapper'><div class = "S5 lineNode"><span class = "S6"><span class="S11">% fig=figure(2);  </span></span></div></div><div class = 'inlineWrapper'><div class = "S5 lineNode"><span class = "S6"><span class="S11">% filename='data/Flight_estimationMap';</span></span></div></div><div class = 'inlineWrapper'><div class = "S5 lineNode"><span class = "S6"><span class="S11">% Frame(g.nt) = struct('cdata',[],'colormap',[]);</span></span></div></div><div class = 'inlineWrapper'><div class = "S5 lineNode"><span class = "S6"><span class="S11">% h=worldmap([min([g.lat]) max([g.lat])], [min([g.lon]) max([g.lon])]); </span></span></div></div><div class = 'inlineWrapper'><div class = "S5 lineNode"><span class = "S6"><span class="S11">% setm(h,'grid','off'); set(findall(h,'Tag','MLabel'),'visible','off'); set(findall(h,'Tag','PLabel'),'visible','off')</span></span></div></div><div class = 'inlineWrapper'><div class = "S5 lineNode"><span class = "S6"><span class="S11">% geoshow('landareas.shp', 'FaceColor', [215 215 215]./255); geoshow('worldrivers.shp','Color', 'blue')</span></span></div></div><div class = 'inlineWrapper'><div class = "S5 lineNode"><span class = "S6"><span class="S11">% set(gcf,'color','w'); hsurf=[];hscat=[];</span></span></div></div><div class = 'inlineWrapper'><div class = "S5 lineNode"><span class = "S6"><span class="S11">% caxis([-15 15]);</span></span></div></div><div class = 'inlineWrapper'><div class = "S5 lineNode"><span class = "S6"><span class="S11">% tmp_u=nan(g.nlat, g.nlon); tmp_v=nan(g.nlat, g.nlon);</span></span></div></div><div class = 'inlineWrapper'><div class = "S5 lineNode"><span class = "S6"><span class="S11">% for i_t = 1:g.nt</span></span></div></div><div class = 'inlineWrapper'><div class = "S5 lineNode"><span class = "S6"><span class="S11">%     delete(hsurf); delete(hscat);</span></span></div></div><div class = 'inlineWrapper'><div class = "S5 lineNode"><span class = "S6"><span class="S11">%     tmp_u(g.latlonmask)=guv.u_est(:,i_t);</span></span></div></div><div class = 'inlineWrapper'><div class = "S5 lineNode"><span class = "S6"><span class="S11">%     tmp_v(g.latlonmask)=guv.v_est(:,i_t);</span></span></div></div><div class = 'inlineWrapper'><div class = "S5 lineNode"><span class = "S6"><span class="S11">%     hsurf=quiverm(g.lat2D,g.lon2D,tmp_u,tmp_v);</span></span></div></div><div class = 'inlineWrapper'><div class = "S5 lineNode"><span class = "S6"><span class="S11">% </span></span></div></div><div class = 'inlineWrapper'><div class = "S5 lineNode"><span class = "S6"><span class="S11">%     % id = abs(intra.time-datenum(g.time(i_t)))&lt;1/24/4;</span></span></div></div><div class = 'inlineWrapper'><div class = "S5 lineNode"><span class = "S6"><span class="S11">%     % hscat=scatterm(data.lat(intra.radar(id)),data.lon(intra.radar(id)),[],intra.I_m(id),'filled','MarkerEdgeColor','k');</span></span></div></div><div class = 'inlineWrapper'><div class = "S5 lineNode"><span class = "S6"><span class="S11">% %     id = abs(data.time-g.time(i_t))&lt;1/24/4;</span></span></div></div><div class = 'inlineWrapper'><div class = "S5 lineNode"><span class = "S6"><span class="S11">% %     hscat=scatterm(data.lat,data.lon,[],nanmean(data.us(id,:),1),'filled','MarkerEdgeColor','k');</span></span></div></div><div class = 'inlineWrapper'><div class = "S5 lineNode"><span class = "S6"><span class="S11">%     </span></span></div></div><div class = 'inlineWrapper'><div class = "S5 lineNode"><span class = "S6"><span class="S11">%     title(datestr(g.time(i_t),'dd-mmm HH:MM'),'FontSize',14); drawnow</span></span></div></div><div class = 'inlineWrapper'><div class = "S5 lineNode"><span class = "S6"><span class="S11">% %     Frame(i_t) = getframe(fig);</span></span></div></div><div class = 'inlineWrapper'><div class = "S5 lineNode"><span class = "S6"><span class="S11">% %     [imind,cm] = rgb2ind(frame2im(Frame(i_t)),256); </span></span></div></div><div class = 'inlineWrapper'><div class = "S5 lineNode"><span class = "S6"><span class="S11">% %     if i_t == 2</span></span></div></div><div class = 'inlineWrapper'><div class = "S5 lineNode"><span class = "S6"><span class="S11">% %         imwrite(imind,cm,[filename '.gif'],'gif', 'DelayTime',0.1,'Loopcount',inf);</span></span></div></div><div class = 'inlineWrapper'><div class = "S5 lineNode"><span class = "S6"><span class="S11">% %     else</span></span></div></div><div class = 'inlineWrapper'><div class = "S5 lineNode"><span class = "S6"><span class="S11">% %         imwrite(imind,cm,[filename '.gif'],'gif', 'DelayTime',0.1,'WriteMode','append');</span></span></div></div><div class = 'inlineWrapper'><div class = "S5 lineNode"><span class = "S6"><span class="S11">% %     end</span></span></div></div><div class = 'inlineWrapper'><div class = "S5 lineNode"><span class = "S6"><span class="S11">% keyboard</span></span></div></div><div class = 'inlineWrapper'><div class = "S5 lineNode"><span class = "S6"><span class="S11">% end</span></span></div></div><div class = 'inlineWrapper'><div class = "S5 lineNode"><span class = "S6"><span class="S11">% v=VideoWriter([filename '.avi']);</span></span></div></div><div class = 'inlineWrapper'><div class = "S5 lineNode"><span class = "S6"><span class="S11">% v.FrameRate = 4;</span></span></div></div><div class = 'inlineWrapper'><div class = "S5 lineNode"><span class = "S6"><span class="S11">% v.Quality = 75;</span></span></div></div><div class = 'inlineWrapper'><div class = "S5 lineNode"><span class = "S6"><span class="S11">% open(v);</span></span></div></div><div class = 'inlineWrapper'><div class = "S5 lineNode"><span class = "S6"><span class="S11">% writeVideo(v, Frame);</span></span></div></div><div class = 'inlineWrapper'><div class = "S5 lineNode"><span class = "S6"><span class="S11">% close(v);</span></span></div></div></div></div><div class = "S0"></div><div class = 'SectionBlock containment'><h2 class = "S8"><span class = "S2"><span class="S0">7. Save</span></span></h2><div class = 'CodeBlock contiguous'><div class = 'inlineWrapper'><div class = "S5 lineNode"><span class = "S6"><span class="S0">save(</span><span class="S7">'data/Flight_estimationMap'</span><span class="S0">,</span><span class="S7">'guv'</span><span class="S0">,</span><span class="S7">'-v7.3'</span><span class="S0">);</span></span></div></div><div class = 'inlineWrapper'><div class = "S5 lineNode"><span class = "S6"><span class="S11">% load('data/Flight_estimationMap')</span></span></div></div></div></div></div><br><!-- <br>##### SOURCE BEGIN #####<br>%% Map Estimation<br>%% 1. Load data<br><br>clear all; warning off<br>load('./data/Density_inference.mat','data');<br>load('./data/Density_estimationMap','g');<br>load('./data/Flight_inference.mat');<br>addpath('./functions/'); <br>load coastlines.mat<br>%% 4. Multi-night scale<br>% Covariance matrix of weather radars<br>%%<br>gfmulti.Mu_est = nan(g.nlm,g.nat);<br>gfmulti.Mu_sig = nan(g.nlm,g.nat);<br>gfmulti.Mv_est = nan(g.nlm,g.nat);<br>gfmulti.Mv_est = nan(g.nlm,g.nat);<br><br>for i_b=1:numel(data.block.date)<br>    id = ~fmulti.isnan & fmulti.B==i_b;<br>    Dtime=squareform(pdist(fmulti.T(id)));<br>    Ddist_aa=squareform(pdist([data.lat(fmulti.R(id)) data.lon(fmulti.R(id))],@lldistkm));<br>    <br>    Ddist_ab = pdist2([data.lat data.lon], [g.lat2D(g.latlonmask) g.lon2D(g.latlonmask)], @lldistkm);<br>    Ddist_sf = Ddist_ab(fmulti.R(id), repmat((1:g.nlm)',sum(g.day_b==i_b),1));<br>    Dtime_sf = pdist2(fmulti.T(id), repelem(datenum(g.day(g.day_b==i_b)),g.nlm,1));<br>    <br>    % u<br>    Caa = fmulti.cov.C_u(Ddist_aa,Dtime,i_b);<br>    Cab = fmulti.cov.C_u(Ddist_sf,Dtime_sf,i_b);<br>    Lambda = inv(Caa)*Cab;<br>    gfmulti.Mu_est(:,g.day_b==i_b) = reshape((Lambda' * fmulti.Mus(id)) + fmulti.f_trend(repelem(datenum(g.day(g.day_b==i_b)),g.nlm,1), repmat(g.lat2D(g.latlonmask),sum(g.day_b==i_b),1), repmat(g.lon2D(g.latlonmask),sum(g.day_b==i_b),1), fmulti.beta_u(:,i_b)), g.nlm, sum(g.day_b==i_b));<br>    gfmulti.Mu_sig(:,g.day_b==i_b) = reshape( sqrt(sum(fmulti.cov.parm_u(1:2,i_b)) - sum(Lambda.*Cab)), g.nlm, sum(g.day_b==i_b));<br>    <br>    % v<br>    Caa = fmulti.cov.C_v(Ddist_aa,Dtime,i_b);<br>    Cab = fmulti.cov.C_v(Ddist_sf,Dtime_sf,i_b);<br>    Lambda = inv(Caa)*Cab;<br>    gfmulti.Mv_est(:,g.day_b==i_b) = reshape((Lambda' * fmulti.Mvs(id)) + fmulti.f_trend(repelem(datenum(g.day(g.day_b==i_b)),g.nlm,1), repmat(g.lat2D(g.latlonmask),sum(g.day_b==i_b),1), repmat(g.lon2D(g.latlonmask),sum(g.day_b==i_b),1), fmulti.beta_v(:,i_b)), g.nlm, sum(g.day_b==i_b));<br>    gfmulti.Mv_sig(:,g.day_b==i_b) = reshape( sqrt(sum(fmulti.cov.parm_v(1:2,i_b)) - sum(Lambda.*Cab)), g.nlm, sum(g.day_b==i_b));<br>        <br>end<br>%% <br>% Figure<br>%%<br>% tmp=nan(g.nlat, g.nlon);<br>% figure('position',[0 0 1000 600]); <br>% i=1;<br>% for i_t = 1:12:4*6<br>%     subplot(4,6,i); hold on; i=i+1;<br>%     h=worldmap([min([g.lat]) max([g.lat])], [min([g.lon]) max([g.lon])]); <br>%     setm(h,'frame','on','grid','off'); set(findall(h,'Tag','MLabel'),'visible','off'); set(findall(h,'Tag','PLabel'),'visible','off')<br>%     geoshow('landareas.shp', 'FaceColor', [215 215 215]./255); geoshow('worldrivers.shp','Color', 'blue')<br>%     tmp(g.latlonmask) = gfmulti.Mu_est(:,i_t);<br>%     surfm(g.lat2D,g.lon2D,tmp); caxis([-15 15])<br>%     i_tt=find(datenum(g.day(i_t))==data.day);<br>%     scatterm(data.lat(~isnan(fmulti.Mus(i_tt,:))),data.lon(~isnan(fmulti.Mus(i_tt,:))),100,fmulti.Mus(i_tt,~isnan(fmulti.Mus(i_tt,:))),'filled','MarkerEdgeColor','k')<br>%     title(datestr(g.day(i_t),'dd-mmm'))<br>% end<br>%% <br>% Export as gif<br>%%<br>% % filename='data/Density_estimationMap_M';<br>% filename='data/Density_estimationMap_M';<br>% Frame(g.nat) = struct('cdata',[],'colormap',[]); <br>% fig=figure(2); <br>% h=worldmap([min([g.lat]) max([g.lat])], [min([g.lon]) max([g.lon])]); <br>% setm(h,'frame','on','grid','off'); set(findall(h,'Tag','MLabel'),'visible','off'); set(findall(h,'Tag','PLabel'),'visible','off')<br>% geoshow('landareas.shp', 'FaceColor', [215 215 215]./255); geoshow('worldrivers.shp','Color', 'blue')<br>% set(gcf,'color','w'); hsurf=[];hscat=[];<br>% caxis([-3 3]); <br>% tmp=nan(g.nlat, g.nlon);<br>% %caxis([0 80]);  c=colorbar;c.Label.String = 'Bird density [bird/km^2]';c.Label.FontSize=14;<br>% for i_t = 1:g.nat<br>%     delete(hsurf); delete(hscat)<br>%     tmp(g.latlonmask) = gmulti.M_est(:,i_t);<br>%     hsurf=surfm(g.lat2D,g.lon2D,tmp);<br>%     i_tt=find(datenum(g.day(i_t))==data.day);<br>%     hscat=scatterm(data.lat(~isnan(multi.M_m(i_tt,:))),data.lon(~isnan(multi.M_m(i_tt,:))),100,multi.M_m(i_tt,~isnan(multi.M_m(i_tt,:))),'filled','MarkerEdgeColor','k');<br>%     <br>%     title(datestr(g.day(i_t),'dd-mmm'),'FontSize',14); drawnow;<br>%     Frame(i_t) = getframe(fig);<br>%     [imind,cm] = rgb2ind(frame2im(Frame(i_t)),256); <br>%     if i_t == 1<br>%         imwrite(imind,cm,[filename '.gif'],'gif','Loopcount',inf);<br>%     else<br>%         imwrite(imind,cm,[filename '.gif'],'gif','WriteMode','append');<br>%     end<br>% end<br><br>%% <br>% <br>%% 5. Intra-night scale<br>% Covariance matrix of weather radar data <br>%%<br>gfintra.Ius_est = nan(g.nlm,g.nt);<br>gfintra.Ius_sig = nan(g.nlm,g.nt);<br>gfintra.Ivs_est = nan(g.nlm,g.nt);<br>gfintra.Ivs_sig = nan(g.nlm,g.nt);<br><br>Ddist_rr_sm = squareform(pdist([data.lat data.lon], @lldistkm));<br>Ddist_rg_sm = pdist2([data.lat data.lon], [g.lat2D(g.latlonmask) g.lon2D(g.latlonmask)], @lldistkm);<br>tic<br>for i_t=1:g.nt<br>    disp([num2str(round(i_t/g.nat*100)) '%  ' num2str(toc/60) 'min'])<br>    i_b = g.day_b(i_t);<br>    id_r = fintra.day==datenum(g.day(i_t));<br>    id_g = g.day_id == i_t;<br>    <br>    Dtime_rr = squareform(pdist(fintra.time(id_r)));<br>    Ddist_rr = Ddist_rr_sm(fintra.radar(id_r),fintra.radar(id_r));<br>    <br>    Dtime_rg = pdist2(fintra.time(id_r),datenum(g.time(id_g)));<br>    Dtime_rg = Dtime_rg(:,repelem((1:sum(id_g))',g.nlm,1));<br>    Ddist_rg = Ddist_rg_sm(fintra.radar(id_r),:);<br>    Ddist_rg = repmat(Ddist_rg,1,sum(id_g));<br>    <br>    id = g.mask_day(:,id_g);<br>    id2 = false(size(gfintra.Ius_est));<br>    id2(:,id_g)=id;<br>    <br>    % u<br>    Crr = fintra.cov.C_u(Ddist_rr,Dtime_rr,i_b);<br>    Crg = fintra.cov.C_u(Ddist_rg(:,id(:)),Dtime_rg(:,id(:)),i_b);<br>    Lambda = inv(Crr)*Crg;<br><br>    gfintra.Ius_est(id2) = (Lambda' * fintra.Ius_n(id_r)) .* sqrt(fintra.f_trend(g.NNT(id2),fintra.beta_u(:,i_b)));<br>    gfintra.Ius_sig(id2) = sqrt( (sum(fintra.cov.parm_u(1:2,i_b)) - sum(Lambda.*Crg))  .* fintra.f_trend(g.NNT(id2)',fintra.beta_u(:,i_b)) ); <br>    <br>    % v<br>    Crr = fintra.cov.C_v(Ddist_rr,Dtime_rr,i_b);<br>    Crg = fintra.cov.C_v(Ddist_rg(:,id(:)),Dtime_rg(:,id(:)),i_b);<br>    Lambda = inv(Crr)*Crg;<br><br>    gfintra.Ivs_est(id2) = (Lambda' * fintra.Ivs_n(id_r)) .* sqrt(fintra.f_trend(g.NNT(id2),fintra.beta_v(:,i_b)));<br>    gfintra.Ivs_sig(id2) = sqrt( (sum(fintra.cov.parm_v(1:2,i_b)) - sum(Lambda.*Crg))  .* fintra.f_trend(g.NNT(id2)',fintra.beta_v(:,i_b)) ); <br>        <br>end<br>%% 6 Reassemble<br>%%<br>guv.u_est = gfmulti.Mu_est(:,g.day_id) + gfintra.Ius_est;<br>guv.v_est = gfmulti.Mv_est(:,g.day_id) + gfintra.Ivs_est;<br>guv.u_sig = sqrt(gfmulti.Mu_sig(:,g.day_id).^2 + gfintra.Ius_sig.^2);<br>guv.v_sig = sqrt(gfmulti.Mv_sig(:,g.day_id).^2 + gfintra.Ivs_sig.^2);<br>%% <br>% Figure<br>%%<br>% fig=figure(2);  <br>% filename='data/Flight_estimationMap';<br>% Frame(g.nt) = struct('cdata',[],'colormap',[]);<br>% h=worldmap([min([g.lat]) max([g.lat])], [min([g.lon]) max([g.lon])]); <br>% setm(h,'grid','off'); set(findall(h,'Tag','MLabel'),'visible','off'); set(findall(h,'Tag','PLabel'),'visible','off')<br>% geoshow('landareas.shp', 'FaceColor', [215 215 215]./255); geoshow('worldrivers.shp','Color', 'blue')<br>% set(gcf,'color','w'); hsurf=[];hscat=[];<br>% caxis([-15 15]);<br>% tmp_u=nan(g.nlat, g.nlon); tmp_v=nan(g.nlat, g.nlon);<br>% for i_t = 1:g.nt<br>%     delete(hsurf); delete(hscat);<br>%     tmp_u(g.latlonmask)=guv.u_est(:,i_t);<br>%     tmp_v(g.latlonmask)=guv.v_est(:,i_t);<br>%     hsurf=quiverm(g.lat2D,g.lon2D,tmp_u,tmp_v);<br>% <br>%     % id = abs(intra.time-datenum(g.time(i_t)))<1/24/4;<br>%     % hscat=scatterm(data.lat(intra.radar(id)),data.lon(intra.radar(id)),[],intra.I_m(id),'filled','MarkerEdgeColor','k');<br>% %     id = abs(data.time-g.time(i_t))<1/24/4;<br>% %     hscat=scatterm(data.lat,data.lon,[],nanmean(data.us(id,:),1),'filled','MarkerEdgeColor','k');<br>%     <br>%     title(datestr(g.time(i_t),'dd-mmm HH:MM'),'FontSize',14); drawnow<br>% %     Frame(i_t) = getframe(fig);<br>% %     [imind,cm] = rgb2ind(frame2im(Frame(i_t)),256); <br>% %     if i_t == 2<br>% %         imwrite(imind,cm,[filename '.gif'],'gif', 'DelayTime',0.1,'Loopcount',inf);<br>% %     else<br>% %         imwrite(imind,cm,[filename '.gif'],'gif', 'DelayTime',0.1,'WriteMode','append');<br>% %     end<br>% keyboard<br>% end<br>% v=VideoWriter([filename '.avi']);<br>% v.FrameRate = 4;<br>% v.Quality = 75;<br>% open(v);<br>% writeVideo(v, Frame);<br>% close(v);<br>%% 7. Save<br>%%<br>save('data/Flight_estimationMap','guv','-v7.3');<br>% load('data/Flight_estimationMap')<br>##### SOURCE END #####<br>--></body></html>